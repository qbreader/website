import questionStats from"../../scripts/auth/question-stats.js";import api from"../../scripts/api/index.js";import audio from"../../audio/index.js";import{arrayToRange,rangeToArray}from"../../scripts/utilities/ranges.js";import createBonusGameCard from"../../scripts/utilities/bonus-game-card.js";import{getDropdownValues}from"../../scripts/utilities/dropdown-checklist.js";import CategoryModal from"../../scripts/components/CategoryModal.min.js";import DifficultyDropdown from"../../scripts/components/DifficultyDropdown.min.js";import ClientBonusRoom from"../ClientBonusRoom.js";import Player from"../../../quizbowl/Player.js";import Team from"../../../quizbowl/Team.js";import{MODE_ENUM}from"../../../quizbowl/constants.js";let maxPacketNumber=24;const modeVersion="2025-01-14",queryVersion="2024-11-01",settingsVersion="2024-11-02",USER_ID="user",TEAM_ID="team",room=new ClientBonusRoom;room.players[USER_ID]=new Player(USER_ID),room.players[USER_ID].teamId=TEAM_ID,room.teams[TEAM_ID]=new Team(TEAM_ID);const socket={send:onmessage,sendToServer:a=>room.message(USER_ID,a)};room.sockets[TEAM_ID]=socket;function onmessage(a){const b=JSON.parse(a);switch(b.type){case"alert":return window.alert(b.message);case"clear-stats":return clearStats(b);case"end":return next(b);case"end-of-set":return endOfSet(b);case"give-answer":return giveAnswer(b);case"next":return next(b);case"no-questions-found":return noQuestionsFound(b);case"reveal-leadin":return revealLeadin(b);case"reveal-next-answer":return revealNextAnswer(b);case"reveal-next-part":return revealNextPart(b);case"set-categories":return setCategories(b);case"set-difficulties":return setDifficulties(b);case"set-mode":return setMode(b);case"set-packet-numbers":return setPacketNumbers(b);case"set-set-name":return setSetName(b);case"set-strictness":return setStrictness(b);case"set-year-range":return setYearRange(b);case"skip":return next(b);case"start":return next(b);case"start-answer":return startAnswer(b);case"timer-update":return updateTimerDisplay(b.timeRemaining);case"toggle-correct":return toggleCorrect(b);case"toggle-show-history":return toggleShowHistory(b);case"toggle-standard-only":return toggleStandardOnly(b);case"toggle-three-part-bonuses":return toggleThreePartBonuses(b);case"toggle-timer":return toggleTimer(b);case"toggle-type-to-answer":return toggleTypeToAnswer(b)}}function clearStats({teamId:a}){updateStatDisplay({0:0,10:0,20:0,30:0})}function endOfSet(){window.alert("You have reached the end of the set")}async function giveAnswer({currentPartNumber:a,directive:b,directedPrompt:c}){if("prompt"===b)return document.getElementById("answer-input-group").classList.remove("d-none"),document.getElementById("answer-input").focus(),void(document.getElementById("answer-input").placeholder=c?`Prompt: "${c}"`:"Prompt");document.getElementById("answer-input").value="",document.getElementById("answer-input").blur(),document.getElementById("answer-input").placeholder="Enter answer",document.getElementById("answer-input-group").classList.add("d-none");"accept"===b?(document.getElementById(`checkbox-${a+1}`).checked=!0,document.getElementById("reveal").disabled=!1,audio.soundEffects&&audio.correct.play()):"reject"===b?(document.getElementById("reveal").disabled=!1,audio.soundEffects&&audio.incorrect.play()):void 0}function noQuestionsFound(){window.alert("No questions found")}async function next({type:a,bonus:b,lastPartRevealed:c,oldBonus:d,packetLength:e,pointsPerPart:f,stats:g,teamId:h}){"start"===a&&(document.getElementById("next").disabled=!1,document.getElementById("settings").classList.add("d-none")),"start"!==a&&createBonusGameCard({bonus:d,starred:!(room.mode!==MODE_ENUM.STARRED)||room.mode!==MODE_ENUM.LOCAL&&null}),document.getElementById("question").textContent="","end"===a?(document.getElementById("next").disabled=!0,document.getElementById("reveal").disabled=!0):(document.getElementById("next").textContent="Skip",document.getElementById("packet-length-info").textContent=room.mode===MODE_ENUM.SET_NAME?e:"-",document.getElementById("packet-number-info").textContent=b.packet.number,document.getElementById("reveal").disabled=!1,document.getElementById("set-name-info").textContent=b.set.name,document.getElementById("question-number-info").textContent=b.number),c&&room.mode!==MODE_ENUM.LOCAL&&(questionStats.recordBonus({_id:d._id,pointsPerPart:f}),updateStatDisplay(g))}/**
 * Called when the users wants to reveal the next bonus part.
 */function revealNextAnswer({answer:a,currentPartNumber:b,lastPartRevealed:c}){const d=document.createElement("p");d.innerHTML="ANSWER: "+a,document.getElementById(`bonus-part-${b+1}`).appendChild(d),c&&(document.getElementById("reveal").disabled=!0,document.getElementById("next").textContent="Next")}function revealLeadin({leadin:a}){const b=document.createElement("p");b.id="leadin",b.innerHTML=a,document.getElementById("question").appendChild(b)}function revealNextPart({currentPartNumber:a,part:b,value:c}){const d=document.createElement("input");d.id=`checkbox-${a+1}`,d.className="checkbox form-check-input rounded-0 me-1",d.type="checkbox",d.style="width: 20px; height: 20px; cursor: pointer",d.addEventListener("click",function(){socket.sendToServer({type:"toggle-correct",partNumber:a,correct:this.checked})});const e=document.createElement("label");e.style="cursor: pointer",e.appendChild(d);const f=document.createElement("p");f.innerHTML=`[${c}] ${b}`;const g=document.createElement("div");g.id=`bonus-part-${a+1}`,g.appendChild(f);const h=document.createElement("div");h.className="d-flex",h.appendChild(e),h.appendChild(g),document.getElementById("question").appendChild(h)}function setCategories({alternateSubcategories:a,categories:b,subcategories:c,percentView:d,categoryPercents:e}){room.categoryManager.loadCategoryModal(),window.localStorage.setItem("singleplayer-bonus-query",JSON.stringify({...room.query,version:queryVersion}))}function setDifficulties({difficulties:a}){window.localStorage.setItem("singleplayer-bonus-query",JSON.stringify({...room.query,version:queryVersion}))}function setPacketNumbers({packetNumbers:a}){document.getElementById("packet-number").value=arrayToRange(a),window.localStorage.setItem("singleplayer-bonus-query",JSON.stringify({...room.query,version:queryVersion}))}async function setSetName({setName:a,setLength:b}){document.getElementById("set-name").value=a;// make border red if set name is not in set list
const c=!a||api.getSetList().includes(a);document.getElementById("set-name").classList.toggle("is-invalid",!c),maxPacketNumber=b,document.getElementById("packet-number").placeholder="Packet Numbers"+(maxPacketNumber?` (1-${maxPacketNumber})`:""),window.localStorage.setItem("singleplayer-bonus-query",JSON.stringify({...room.query,version:queryVersion}))}function setStrictness({strictness:a}){document.getElementById("set-strictness").value=a,document.getElementById("strictness-display").textContent=a,window.localStorage.setItem("singleplayer-bonus-settings",JSON.stringify({...room.settings,version:settingsVersion}))}function setYearRange({minYear:a,maxYear:b}){$("#slider").slider("values",[a,b]),document.getElementById("year-range-a").textContent=a,document.getElementById("year-range-b").textContent=b,window.localStorage.setItem("singleplayer-bonus-query",JSON.stringify({...room.query,version:queryVersion}))}function startAnswer(){document.getElementById("answer-input-group").classList.remove("d-none"),document.getElementById("answer-input").focus(),document.getElementById("reveal").disabled=!0}function toggleCorrect({partNumber:a,correct:b}){document.getElementById(`checkbox-${a+1}`).checked=b}function setMode({mode:a}){a===MODE_ENUM.SET_NAME?(document.getElementById("difficulty-settings").classList.add("d-none"),document.getElementById("local-packet-settings").classList.add("d-none"),document.getElementById("set-settings").classList.remove("d-none"),document.getElementById("toggle-standard-only").disabled=!0,document.getElementById("toggle-three-part-bonuses").disabled=!0):a===MODE_ENUM.RANDOM?(document.getElementById("difficulty-settings").classList.remove("d-none"),document.getElementById("local-packet-settings").classList.add("d-none"),document.getElementById("set-settings").classList.add("d-none"),document.getElementById("toggle-standard-only").disabled=!1,document.getElementById("toggle-three-part-bonuses").disabled=!1):a===MODE_ENUM.STARRED?(document.getElementById("difficulty-settings").classList.add("d-none"),document.getElementById("local-packet-settings").classList.add("d-none"),document.getElementById("set-settings").classList.add("d-none"),document.getElementById("toggle-standard-only").disabled=!0,document.getElementById("toggle-three-part-bonuses").disabled=!0):a===MODE_ENUM.LOCAL?(document.getElementById("difficulty-settings").classList.add("d-none"),document.getElementById("local-packet-settings").classList.remove("d-none"),document.getElementById("set-settings").classList.add("d-none"),document.getElementById("toggle-standard-only").disabled=!0,document.getElementById("toggle-three-part-bonuses").disabled=!0):void 0;document.getElementById("set-mode").value=a,window.localStorage.setItem("singleplayer-bonus-mode",JSON.stringify({mode:a,version:modeVersion}))}function toggleShowHistory({showHistory:a}){document.getElementById("room-history").classList.toggle("d-none",!a),document.getElementById("toggle-show-history").checked=a,window.localStorage.setItem("singleplayer-bonus-settings",JSON.stringify({...room.settings,version:settingsVersion}))}function toggleStandardOnly({standardOnly:a}){document.getElementById("toggle-standard-only").checked=a,window.localStorage.setItem("singleplayer-bonus-query",JSON.stringify({...room.query,version:queryVersion}))}function toggleThreePartBonuses({threePartBonuses:a}){document.getElementById("toggle-three-part-bonuses").checked=a,window.localStorage.setItem("singleplayer-bonus-query",JSON.stringify({...room.query,version:queryVersion}))}function toggleTimer({timer:a}){document.getElementById("timer").classList.toggle("d-none",!a),document.getElementById("toggle-timer").checked=a,window.localStorage.setItem("singleplayer-bonus-settings",JSON.stringify({...room.settings,version:settingsVersion}))}function toggleTypeToAnswer({typeToAnswer:a}){document.getElementById("type-to-answer").checked=a,window.localStorage.setItem("singleplayer-bonus-settings",JSON.stringify({...room.settings,version:settingsVersion}))}/**
 * Calculates the points per bonus and updates the display.
 */function updateStatDisplay(a){const b=a[0]+a[10]+a[20]+a[30],c=30*a[30]+20*a[20]+10*a[10],d=Math.round(100*c/b)/100||0,e=1===b?"":"es";document.getElementById("statline").textContent=`${d} PPB with ${b} bonus${e} seen (${a[30]}/${a[20]}/${a[10]}/${a[0]}, ${c} pts)`}function updateTimerDisplay(a){const b=Math.floor(a/10);document.querySelector(".timer .face").textContent=b,document.querySelector(".timer .fraction").textContent="."+a%10}if(document.getElementById("answer-form").addEventListener("submit",function(a){a.preventDefault(),a.stopPropagation();const b=document.getElementById("answer-input").value;socket.sendToServer({type:"give-answer",givenAnswer:b})}),document.getElementById("clear-stats").addEventListener("click",function(){this.blur(),room.sendToServer({type:"clear-stats"})}),document.getElementById("next").addEventListener("click",function(){this.blur(),"Skip"===this.innerHTML?socket.sendToServer({type:"skip"}):socket.sendToServer({type:"next"})}),document.getElementById("local-packet-input").addEventListener("change",function(){const a=this.files[0];if(a){const b=new window.FileReader;b.onload=function(b){try{const c=JSON.parse(b.target.result);socket.sendToServer({type:"upload-local-packet",packet:c,filename:a.name})}catch(a){window.alert("Invalid packet format")}},b.readAsText(a)}}),document.getElementById("packet-number").addEventListener("change",function(){const a=rangeToArray(this.value.trim(),maxPacketNumber),b=a.some(a=>1>a||a>maxPacketNumber);return b?void document.getElementById("packet-number").classList.add("is-invalid"):void(document.getElementById("packet-number").classList.remove("is-invalid"),socket.sendToServer({type:"set-packet-numbers",packetNumbers:a}))}),document.getElementById("report-question-submit").addEventListener("click",function(){api.reportQuestion(document.getElementById("report-question-id").value,document.getElementById("report-question-reason").value,document.getElementById("report-question-description").value)}),document.getElementById("reveal").addEventListener("click",function(){this.blur(),socket.sendToServer({type:"start-answer"})}),document.getElementById("set-mode").addEventListener("change",function(){this.blur(),socket.sendToServer({type:"set-mode",mode:this.value})}),document.getElementById("set-name").addEventListener("change",function(){socket.sendToServer({type:"set-set-name",setName:this.value.trim()})}),document.getElementById("set-strictness").addEventListener("change",function(){this.blur(),socket.sendToServer({type:"set-strictness",strictness:this.value})}),document.getElementById("set-strictness").addEventListener("input",function(){document.getElementById("strictness-display").textContent=this.value}),document.getElementById("start").addEventListener("click",async function(){this.blur(),socket.sendToServer({type:"start"})}),document.getElementById("toggle-settings").addEventListener("click",function(){this.blur(),document.getElementById("buttons").classList.toggle("col-lg-9"),document.getElementById("buttons").classList.toggle("col-lg-12"),document.getElementById("content").classList.toggle("col-lg-9"),document.getElementById("content").classList.toggle("col-lg-12"),document.getElementById("settings").classList.toggle("d-none"),document.getElementById("settings").classList.toggle("d-lg-none")}),document.getElementById("toggle-show-history").addEventListener("click",function(){this.blur(),socket.sendToServer({type:"toggle-show-history",showHistory:this.checked})}),document.getElementById("toggle-standard-only").addEventListener("click",function(){this.blur(),socket.sendToServer({type:"toggle-standard-only",standardOnly:this.checked})}),document.getElementById("toggle-three-part-bonuses").addEventListener("click",function(){this.blur(),socket.sendToServer({type:"toggle-three-part-bonuses",threePartBonuses:this.checked})}),document.getElementById("toggle-timer").addEventListener("click",function(){this.blur(),socket.sendToServer({type:"toggle-timer",timer:this.checked})}),document.getElementById("type-to-answer").addEventListener("click",function(){this.blur(),socket.sendToServer({type:"toggle-type-to-answer",typeToAnswer:this.checked})}),document.getElementById("year-range-a").onchange=function(){const a=$("#slider").slider("values",0),b=$("#slider").slider("values",1);socket.sendToServer({type:"set-year-range",minYear:a,maxYear:b})},document.getElementById("year-range-b").onchange=function(){const a=$("#slider").slider("values",0),b=$("#slider").slider("values",1);socket.sendToServer({type:"set-year-range",minYear:a,maxYear:b})},document.addEventListener("keydown",a=>{if(!["INPUT","TEXTAREA","SELECT"].includes(document.activeElement.tagName))switch(a.key?.toLowerCase()){case" ":document.getElementById("reveal").click(),a.target===document.body&&a.preventDefault();break;case"e":return document.getElementById("toggle-settings").click();case"k":return document.getElementsByClassName("card-header-clickable")[0].click();case"n":return document.getElementById("next").click();case"s":return document.getElementById("start").click();case"t":return document.getElementsByClassName("star-bonus")[0].click();case"y":return navigator.clipboard.writeText(room.bonus._id??"");case"0":return document.getElementById(`checkbox-${room.pointsPerPart.length}`)?.click();case"1":return document.getElementById("checkbox-1").click();case"2":return document.getElementById("checkbox-2").click();case"3":return document.getElementById("checkbox-3").click();case"4":return document.getElementById("checkbox-4").click()}}),window.localStorage.getItem("singleplayer-bonus-mode"))try{const a=JSON.parse(window.localStorage.getItem("singleplayer-bonus-mode"));if(a.version!==modeVersion)throw new Error;socket.sendToServer({type:"set-mode",...a})}catch{window.localStorage.removeItem("singleplayer-bonus-mode")}let startingDifficulties=[];if(window.localStorage.getItem("singleplayer-bonus-query"))try{const a=JSON.parse(window.localStorage.getItem("singleplayer-bonus-query"));if(a.version!==queryVersion)throw new Error;room.categoryManager.import(a),room.query=a,socket.sendToServer({type:"set-packet-numbers",...a}),socket.sendToServer({type:"set-set-name",...a}),socket.sendToServer({type:"toggle-standard-only",...a}),socket.sendToServer({type:"toggle-three-part-bonuses",...a}),startingDifficulties=a.difficulties}catch{window.localStorage.removeItem("singleplayer-bonus-query")}if($(document).ready(function(){try{const a=JSON.parse(window.localStorage.getItem("singleplayer-bonus-query"));socket.sendToServer({type:"set-year-range",...a})}catch{}}),window.localStorage.getItem("singleplayer-bonus-settings"))try{const a=JSON.parse(window.localStorage.getItem("singleplayer-bonus-settings"));if(a.version!==settingsVersion)throw new Error;socket.sendToServer({type:"set-strictness",...a}),socket.sendToServer({type:"toggle-show-history",...a}),socket.sendToServer({type:"toggle-timer",...a}),socket.sendToServer({type:"toggle-type-to-answer",...a})}catch{window.localStorage.removeItem("singleplayer-bonus-settings")}ReactDOM.createRoot(document.getElementById("category-modal-root")).render(/*#__PURE__*/React.createElement(CategoryModal,{categoryManager:room.categoryManager,onClose:()=>socket.sendToServer({type:"set-categories",...room.categoryManager.export()})})),ReactDOM.createRoot(document.getElementById("difficulty-dropdown-root")).render(/*#__PURE__*/React.createElement(DifficultyDropdown,{startingDifficulties:startingDifficulties??[],onChange:()=>socket.sendToServer({type:"set-difficulties",difficulties:getDropdownValues("difficulties")})}));