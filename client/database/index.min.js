import{downloadQuestionsAsText,downloadBonusesAsCSV,downloadTossupsAsCSV,downloadQuestionsAsJSON}from"./download.js";import api from"../scripts/api/index.js";import star from"../scripts/auth/star.js";import TossupCard from"../scripts/components/TossupCard.min.js";import BonusCard from"../scripts/components/BonusCard.min.js";import CategoryModal from"../scripts/components/CategoryModal.min.js";import DifficultyDropdown from"../scripts/components/DifficultyDropdown.min.js";import Star from"../scripts/components/Star.min.js";import{getDropdownValues}from"../scripts/utilities/dropdown-checklist.js";import CategoryManager from"../../quizbowl/category-manager.js";import insertTokensIntoHTML from"../../quizbowl/insert-tokens-into-html.js";const starredTossupIds=new Set(await star.getStarredTossupIds()),starredBonusIds=new Set(await star.getStarredBonusIds()),fontSize="true"===window.localStorage.getItem("database-font-size")?window.localStorage.getItem("font-size")??16:16,paginationShiftLength=992<window.screen.width?10:5,categoryManager=new CategoryManager;function arrayBetween(a,b){return Array(b-a).fill().map((b,c)=>a+c)}function getMatchIndices(a,b){const c=a.matchAll(b),d=[],e=[];for(let f=c.next();!1===f.done;)d.push(f.value.index),e.push(f.value.index+f.value[0].length),f=c.next();return{starts:d,ends:e}}function highlightTossupQuery({tossup:a,regExp:b,searchType:e="all",ignoreWordOrder:c,queryString:d}){const f=c?d.split(" ").filter(a=>""!==a).map(a=>new RegExp(a,"ig")):[b];for(const g of f){if("question"===e||"all"===e){const{starts:b,ends:c}=getMatchIndices(a.question_sanitized,g);a.question=insertTokensIntoHTML(a.question,a.question_sanitized,[b,c])}if("answer"===e||"all"===e){const{starts:b,ends:c}=getMatchIndices(a.answer_sanitized,g);a.answer=insertTokensIntoHTML(a.answer,a.answer_sanitized,[b,c])}}return a}function highlightBonusQuery({bonus:a,regExp:b,searchType:e="all",ignoreWordOrder:c,queryString:d}){const f=c?d.split(" ").filter(a=>""!==a).map(a=>new RegExp(a,"ig")):[b];for(const g of f){if("question"===e||"all"===e){{const{starts:b,ends:c}=getMatchIndices(a.leadin_sanitized,g);a.leadin=insertTokensIntoHTML(a.leadin,a.leadin_sanitized,[b,c])}for(let b=0;b<a.parts.length;b++){const{starts:c,ends:d}=getMatchIndices(a.parts_sanitized[b],g);a.parts[b]=insertTokensIntoHTML(a.parts[b],a.parts_sanitized[b],[c,d])}}if("answer"===e||"all"===e)for(let b=0;b<a.answers.length;b++){const{starts:c,ends:d}=getMatchIndices(a.answers_sanitized[b],g);a.answers[b]=insertTokensIntoHTML(a.answers[b],a.answers_sanitized[b],[c,d])}}return a}function QueryForm(){function a(){return Math.floor(1e4/(u||25))}/**
   *
   * @param {"tossup" | "bonus"} type - The type of question to handle pagination for.
   */function b(b,c,d){b.preventDefault();let f="tossup"===d?W:Y;const g={first:1,previous:Math.max(1,f-1),next:Math.min("tossup"===d?$:aa,f+1,a()),last:Math.min("tossup"===d?$:aa,a())};f=c in g?g[c]:c;const h=paginationShiftLength*Math.floor((f-1)/paginationShiftLength);"tossup"===d?(W=f,X(f),da(h)):(Y=f,Z(f),fa(h)),e(b,!1,!0),window.scrollTo({top:document.getElementById("tossup"===d?"tossups":"bonuses").offsetTop-100,behavior:"smooth"})}function c(a,c){return b(a,c,"tossup")}function d(a,c){return b(a,c,"bonus")}function e(a=null,b=!1,c=!1){const d=window.performance.now();a?.preventDefault(),V(!0),(b||!c)&&(W=1,Y=1,X(W),Z(Y));const e={queryString:s,...categoryManager.export(),difficulties:getDropdownValues("difficulties"),maxReturnLength:u,questionType:A,randomize:b,exactPhrase:K,caseSensitive:M,powermarkOnly:O,regex:G,ignoreWordOrder:I,searchType:y,setName:w,tossupPagination:1===W?"":W,bonusPagination:1===Y?"":Y,minYear:C,maxYear:E};delete e.categoryPercents;const f=Object.fromEntries(Object.entries(e).filter(([a,b])=>""!==b&&null!==b&&void 0!==b&&!1!==b&&!(Array.isArray(b)&&0===b.length)&&("questionType"!==a||"all"!==b)&&("searchType"!==a||"all"!==b))),h=new window.URLSearchParams(f);fetch(`/api/query?${h}`).then(a=>{if(400===a.status)throw new Error("Invalid query");return a}).then(a=>a.json()).then(a=>{const{tossups:c,bonuses:e,queryString:f}=a,j=RegExp(f,M?"g":"ig"),l=Math.max(1,u||25),{count:n,questionArray:p}=c,{count:r,questionArray:t}=e,v=JSON.parse(JSON.stringify(p)),w=JSON.parse(JSON.stringify(t));// create deep copy to highlight
if(""!==s){for(let a=0;a<v.length;a++)v[a]=highlightTossupQuery({tossup:v[a],regExp:j,searchType:y,ignoreWordOrder:I,queryString:s});for(let a=0;a<w.length;a++)w[a]=highlightBonusQuery({bonus:w[a],regExp:j,searchType:y,ignoreWordOrder:I,queryString:s})}o(n),g(p),k(v),q(r),i(t),m(w),b?(_(1),ba(1)):(_(Math.ceil(n/l)),ba(Math.ceil(r/l))),da(paginationShiftLength*Math.floor((W-1)/paginationShiftLength)),fa(paginationShiftLength*Math.floor((Y-1)/paginationShiftLength));const x=window.performance.now(),z=((x-d)/1e3).toFixed(2);ha(z),window.history.pushState({tossups:c,highlightedTossupArray:v,bonuses:e,highlightedBonusArray:w,timeElapsed:z,workingMaxReturnLength:l,randomize:b},"","?"+h)}).catch(a=>{console.error("Error:",a),window.alert("Invalid query. Please check your search parameters and try again.")}).finally(()=>{document.querySelectorAll("b.collapsed[data-bs-toggle=\"collapse\"]").forEach(a=>a.classList.remove("collapsed")),document.querySelectorAll("div.card-container.collapse:not(.show)").forEach(a=>a.classList.add("show")),V(!1)})}const[f,g]=React.useState([]),[h,i]=React.useState([]),[j,k]=React.useState([]),[l,m]=React.useState([]),[n,o]=React.useState(0),[p,q]=React.useState(0),r=new window.URLSearchParams(window.location.search),[s,t]=React.useState(r.get("queryString")??""),[u,v]=React.useState(r.get("maxReturnLength")??""),[w,x]=React.useState(r.get("setName")??""),[y,z]=React.useState(r.get("searchType")??"all"),[A,B]=React.useState(r.get("questionType")??"all"),[C,D]=React.useState(r.get("minYear")??""),[E,F]=React.useState(r.get("maxYear")??""),[G,H]=React.useState("true"===r.get("regex")),[I,J]=React.useState("true"===r.get("ignoreWordOrder")),[K,L]=React.useState("true"===r.get("exactPhrase")),[M,N]=React.useState("true"===r.get("caseSensitive")),[O,P]=React.useState("true"===r.get("powermarkOnly")),[Q,R]=React.useState(!1),[S,T]=React.useState(!1),[U,V]=React.useState(!1);// query form
// toggleable options
let[W,X]=React.useState(1),[Y,Z]=React.useState(1);const[$,_]=React.useState(1),[aa,ba]=React.useState(1),[ca,da]=React.useState(0),[ea,fa]=React.useState(0),[ga,ha]=React.useState(0),ia=[];// paginationShift is one less than the first pagination number selectable
// so if the options are 11, 12, ..., 19, 20, then paginationShift=10
//    if the options are 86, 87, ..., 89, 90, then paginationShift=85
for(let a=0;a<j.length;a++){const b=f[a]._id,c=/*#__PURE__*/React.createElement(Star,{key:b,_id:b,questionType:"tossup",initiallyStarred:starredTossupIds.has(b)});ia.push(/*#__PURE__*/React.createElement(TossupCard,{key:a,tossup:f[a],highlightedTossup:j[a],hideAnswerline:Q,hideCardFooter:S,fontSize:fontSize,topRightComponent:c}))}const ja=[];for(let a=0;a<l.length;a++){const b=h[a]._id,c=/*#__PURE__*/React.createElement(Star,{key:b,_id:b,questionType:"bonus",initiallyStarred:starredBonusIds.has(b)});ja.push(/*#__PURE__*/React.createElement(BonusCard,{key:a,bonus:h[a],highlightedBonus:l[a],hideAnswerlines:Q,hideCardFooter:S,fontSize:fontSize,topRightComponent:c}))}return React.useEffect(()=>{window.addEventListener("popstate",a=>{if(null===a.state)return o(0),g([]),k([]),q(0),i([]),m([]),_(1),ba(1),da(0),void fa(0);const{tossups:b,highlightedTossupArray:c,bonuses:d,highlightedBonusArray:e,timeElapsed:f,workingMaxReturnLength:h,randomize:j}=a.state,{count:l,questionArray:n}=b,{count:p,questionArray:r}=d;o(l),g(n),k(c),q(p),i(r),m(e),j?(_(1),ba(1)):(_(Math.ceil(l/h)),ba(Math.ceil(p/h))),da(paginationShiftLength*Math.floor((W-1)/paginationShiftLength)),fa(paginationShiftLength*Math.floor((Y-1)/paginationShiftLength)),ha(f)}),document.getElementById("set-list").innerHTML=api.getSetList().map(a=>`<option>${a}</option>`).join(""),""!==window.location.search&&e()},[]),/*#__PURE__*/React.createElement("div",null,/*#__PURE__*/React.createElement(CategoryModal,{categoryManager:categoryManager,disablePercentView:!0}),/*#__PURE__*/React.createElement("form",{className:"mt-3",onSubmit:a=>{e(a)}},/*#__PURE__*/React.createElement("div",{className:"input-group mb-2"},/*#__PURE__*/React.createElement("input",{type:"text",className:"form-control",id:"query",placeholder:"Query",value:s,onChange:a=>{t(a.target.value)}}),/*#__PURE__*/React.createElement("button",{type:"submit",className:"btn btn-info"},"Search"),/*#__PURE__*/React.createElement("button",{id:"randomize",className:"btn btn-success",onClick:a=>{e(a,!0)}},"Random")),/*#__PURE__*/React.createElement("div",{className:"row"},/*#__PURE__*/React.createElement("div",{className:"col-6 col-xl-3 mb-2"},/*#__PURE__*/React.createElement(DifficultyDropdown,null)),/*#__PURE__*/React.createElement("div",{className:"col-6 col-xl-3 mb-2"},/*#__PURE__*/React.createElement("input",{type:"number",className:"form-control",id:"max-return-length",placeholder:"# to Display",value:u,onChange:a=>{v(a.target.value)}})),/*#__PURE__*/React.createElement("div",{className:"input-group col-12 col-xl-6 mb-2"},/*#__PURE__*/React.createElement("input",{type:"text",className:"form-control",id:"set-name",placeholder:"Set Name",list:"set-list",value:w,onChange:a=>{x(a.target.value)}}),/*#__PURE__*/React.createElement("datalist",{id:"set-list"}),/*#__PURE__*/React.createElement("button",{type:"button",className:"btn btn-danger",id:"category-select-button","data-bs-toggle":"modal","data-bs-target":"#category-modal"},"Categories"))),/*#__PURE__*/React.createElement("div",{className:"row"},/*#__PURE__*/React.createElement("div",{className:"col-6 col-md-3 mb-2"},/*#__PURE__*/React.createElement("select",{className:"form-select",id:"search-type",value:y,onChange:a=>{z(a.target.value)}},/*#__PURE__*/React.createElement("option",{value:"all"},"All text"),/*#__PURE__*/React.createElement("option",{value:"question"},"Question"),/*#__PURE__*/React.createElement("option",{value:"answer"},"Answer"))),/*#__PURE__*/React.createElement("div",{className:"col-6 col-md-3 mb-2"},/*#__PURE__*/React.createElement("select",{className:"form-select",id:"question-type",value:A,onChange:a=>{B(a.target.value)}},/*#__PURE__*/React.createElement("option",{value:"all"},"All questions"),/*#__PURE__*/React.createElement("option",{value:"tossup"},"Tossups"),/*#__PURE__*/React.createElement("option",{value:"bonus"},"Bonuses"))),/*#__PURE__*/React.createElement("div",{className:"col-6 col-md-3 mb-2"},/*#__PURE__*/React.createElement("input",{type:"number",className:"form-control",id:"min-year",placeholder:"Min Year",value:C,onChange:a=>{D(a.target.value)}})),/*#__PURE__*/React.createElement("div",{className:"col-6 col-md-3 mb-2"},/*#__PURE__*/React.createElement("input",{type:"number",className:"form-control",id:"max-year",placeholder:"Max Year",value:E,onChange:a=>{F(a.target.value)}}))),/*#__PURE__*/React.createElement("div",{className:"row"},/*#__PURE__*/React.createElement("div",{className:"col-12"},/*#__PURE__*/React.createElement("div",{className:"form-check form-switch"},/*#__PURE__*/React.createElement("input",{className:"form-check-input",type:"checkbox",role:"switch",id:"toggle-regex",checked:G,onChange:()=>{H(!G)}}),/*#__PURE__*/React.createElement("label",{className:"form-check-label",htmlFor:"toggle-regex"},"Search using regular expression"),/*#__PURE__*/React.createElement("a",{href:"https://www.sitepoint.com/learn-regex/"}," What's this?")),/*#__PURE__*/React.createElement("div",{className:"form-check form-switch"},/*#__PURE__*/React.createElement("input",{className:"form-check-input",type:"checkbox",role:"switch",id:"toggle-ignore-word-order",checked:!G&&I,disabled:G,onChange:()=>{J(!I)}}),/*#__PURE__*/React.createElement("label",{className:"form-check-label",htmlFor:"toggle-ignore-word-order"},"Ignore word order")),/*#__PURE__*/React.createElement("div",{className:"form-check form-switch"},/*#__PURE__*/React.createElement("input",{className:"form-check-input",type:"checkbox",role:"switch",id:"toggle-exact-phrase",checked:!G&&K,disabled:G,onChange:()=>{L(!K)}}),/*#__PURE__*/React.createElement("label",{className:"form-check-label",htmlFor:"toggle-exact-phrase"},"Search for exact phrase")),/*#__PURE__*/React.createElement("div",{className:"form-check form-switch"},/*#__PURE__*/React.createElement("input",{className:"form-check-input",type:"checkbox",role:"switch",id:"toggle-case-sensitive",checked:M,onChange:()=>{N(!M)}}),/*#__PURE__*/React.createElement("label",{className:"form-check-label",htmlFor:"toggle-case-sensitive"},"Case sensitive search")),/*#__PURE__*/React.createElement("div",{className:"form-check form-switch"},/*#__PURE__*/React.createElement("input",{className:"form-check-input",type:"checkbox",role:"switch",id:"toggle-powermark-only",checked:O,onChange:()=>{P(!O)}}),/*#__PURE__*/React.createElement("label",{className:"form-check-label",htmlFor:"toggle-powermark-only"},"Powermarked tossups only")),/*#__PURE__*/React.createElement("div",{className:"form-check form-switch"},/*#__PURE__*/React.createElement("input",{className:"form-check-input",type:"checkbox",role:"switch",id:"toggle-hide-answerlines",checked:Q,onChange:()=>{R(!Q)}}),/*#__PURE__*/React.createElement("label",{className:"form-check-label",htmlFor:"toggle-hide-answerlines"},"Hide answerlines")),/*#__PURE__*/React.createElement("div",{className:"form-check form-switch"},/*#__PURE__*/React.createElement("input",{className:"form-check-input",type:"checkbox",role:"switch",id:"toggle-hide-card-footers",checked:S,onChange:()=>{T(!S)}}),/*#__PURE__*/React.createElement("label",{className:"form-check-label",htmlFor:"toggle-hide-card-footers"},"Hide card footers")),/*#__PURE__*/React.createElement("div",{className:"float-end"},/*#__PURE__*/React.createElement("b",null,"Download this page:"),/*#__PURE__*/React.createElement("a",{className:"ms-2 clickable",onClick:()=>{downloadQuestionsAsText(f,h)}},"TXT"),/*#__PURE__*/React.createElement("a",{className:"ms-2 clickable",onClick:()=>{downloadTossupsAsCSV(f),downloadBonusesAsCSV(h)}},"CSV"),/*#__PURE__*/React.createElement("a",{className:"ms-2 clickable",onClick:()=>{downloadQuestionsAsJSON(f,h)}},"JSON"))))),U&&/*#__PURE__*/React.createElement("div",{className:"d-block mx-auto mt-3 spinner-border",role:"status"},/*#__PURE__*/React.createElement("span",{className:"d-none"},"Loading...")),/*#__PURE__*/React.createElement("div",{className:"row text-center mt-2 mt-sm-0"},/*#__PURE__*/React.createElement("h3",{id:"tossups"},"Tossups")),0<n?/*#__PURE__*/React.createElement("div",{className:"float-row mb-3"},/*#__PURE__*/React.createElement("span",{className:"text-muted float-start"},"Showing ",f.length," of ",n," results (",ga," seconds)"),"\xA0",/*#__PURE__*/React.createElement("span",{className:"text-muted float-end"},/*#__PURE__*/React.createElement("a",{className:"clickable",onClick:()=>window.scrollTo({top:document.getElementById("bonuses").offsetTop,behavior:"smooth"})},"Jump to bonuses")))// eslint-disable-line
:/*#__PURE__*/React.createElement("div",{className:"text-muted"},"No tossups found"),/*#__PURE__*/React.createElement("div",null,ia),1<$&&/*#__PURE__*/React.createElement("nav",{"aria-label":"tossup nagivation"},/*#__PURE__*/React.createElement("ul",{className:"pagination justify-content-center"},/*#__PURE__*/React.createElement("li",{className:"page-item"},/*#__PURE__*/React.createElement("a",{className:"page-link",href:"#","aria-label":"First",onClick:a=>{c(a,"first")}},"\xAB")),/*#__PURE__*/React.createElement("li",{className:"page-item"},/*#__PURE__*/React.createElement("a",{className:"page-link",href:"#","aria-label":"Previous",onClick:a=>{c(a,"previous")}},"\u2039")),arrayBetween(Math.min(ca),Math.min(ca+paginationShiftLength,$)).map(a=>{const b=W===a+1;return/*#__PURE__*/React.createElement("li",{key:`tossup-pagination-${a+1}`,className:"page-item"},/*#__PURE__*/React.createElement("a",{className:`page-link ${b&&"active"}`,href:"#",onClick:b=>{c(b,a+1)}},a+1))}),/*#__PURE__*/React.createElement("li",{className:"page-item"},/*#__PURE__*/React.createElement("a",{className:"page-link",href:"#","aria-label":"Next",onClick:a=>{c(a,"next")}},"\u203A")),/*#__PURE__*/React.createElement("li",{className:"page-item"},/*#__PURE__*/React.createElement("a",{className:"page-link",href:"#","aria-label":"Last",onClick:a=>{c(a,"last")}},/*#__PURE__*/React.createElement("span",{"aria-hidden":"true"},"\xBB"))))),/*#__PURE__*/React.createElement("div",{className:"mb-5"}),/*#__PURE__*/React.createElement("div",{className:"row text-center"},/*#__PURE__*/React.createElement("h3",{id:"bonuses"},"Bonuses")),0<p?/*#__PURE__*/React.createElement("div",{className:"float-row mb-3"},/*#__PURE__*/React.createElement("span",{className:"text-muted float-start"},"Showing ",h.length," of ",p," results (",ga," seconds)"),"\xA0",/*#__PURE__*/React.createElement("span",{className:"text-muted float-end"},/*#__PURE__*/React.createElement("a",{className:"clickable",onClick:()=>window.scrollTo({top:document.getElementById("tossups").offsetTop,behavior:"smooth"})},"Jump to tossups")))// eslint-disable-line
:/*#__PURE__*/React.createElement("div",{className:"text-muted"},"No bonuses found"),/*#__PURE__*/React.createElement("div",null,ja),1<aa&&/*#__PURE__*/React.createElement("nav",{"aria-label":"bonus nagivation"},/*#__PURE__*/React.createElement("ul",{className:"pagination justify-content-center"},/*#__PURE__*/React.createElement("li",{className:"page-item"},/*#__PURE__*/React.createElement("a",{className:"page-link",href:"#","aria-label":"First",onClick:a=>{d(a,"first")}},"\xAB")),/*#__PURE__*/React.createElement("li",{className:"page-item"},/*#__PURE__*/React.createElement("a",{className:"page-link",href:"#","aria-label":"Previous",onClick:a=>{d(a,"previous")}},"\u2039")),arrayBetween(Math.min(ea),Math.min(ea+paginationShiftLength,aa)).map(a=>{const b=Y===a+1;return/*#__PURE__*/React.createElement("li",{key:`bonus-pagination-${a+1}`,className:"page-item"},/*#__PURE__*/React.createElement("a",{className:`page-link ${b&&"active"}`,href:"#",onClick:b=>{d(b,a+1)}},a+1))}),/*#__PURE__*/React.createElement("li",{className:"page-item"},/*#__PURE__*/React.createElement("a",{className:"page-link",href:"#","aria-label":"Next",onClick:a=>{d(a,"next")}},"\u203A")),/*#__PURE__*/React.createElement("li",{className:"page-item"},/*#__PURE__*/React.createElement("a",{className:"page-link",href:"#","aria-label":"Last",onClick:a=>{d(a,"last")}},/*#__PURE__*/React.createElement("span",{"aria-hidden":"true"},"\xBB"))))),/*#__PURE__*/React.createElement("div",{className:"mb-5"}))}const root=ReactDOM.createRoot(document.getElementById("root"));root.render(/*#__PURE__*/React.createElement(QueryForm,null)),document.getElementById("report-question-submit").addEventListener("click",function(){api.reportQuestion(document.getElementById("report-question-id").value,document.getElementById("report-question-reason").value,document.getElementById("report-question-description").value)});